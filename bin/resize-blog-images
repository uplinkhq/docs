#!/usr/bin/env ruby

require "json"
require "fileutils"

MAX_WIDTH = 800

Dir[File.join("blog", "**", "*.{png,jpg}")].each do |path|
  result = `ffprobe -v error -show_entries stream=height -of json "#{path}"`
  width = JSON.parse(result)["streams"][0]["width"]
  next if width <= MAX_WIDTH
  filename = File.basename(path)
  new_filename = [
    Time.now.to_i,
    filename
  ].join("_")
  FileUtils.chdir File.dirname(path) do
    `ffmpeg -i #{filename} -vf scale=#{MAX_WIDTH}:-1 #{new_filename} -y`
    FileUtils.mv new_filename, filename
  end
end
